name: Build app
on:
  push:
    branches: [main]
    tags: ['*.*.*']
  pull_request:
    branches: [main]
jobs:
  build-megaton:
    name: Build Megaton project
    runs-on: ubuntu-latest
    container:
      image: devkitpro/devkita64
      env:
        CARGO_TERM_COLOR: always
    steps:
      - id: checkout
        name: Check out repository
        uses: actions/checkout@v6
        with:
          submodules: true
      - id: build-essential
        name: Install build-essential
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential
      - id: rustup
        name: Install Rust
        run: |
          curl -fsSL --tlsv1.3 https://sh.rustup.rs | bash -s -- -vy --no-modify-path
          realpath ~/.cargo/bin >> "$GITHUB_PATH"
      - id: clone-megaton
        name: Clone Megaton
        run: git clone -b static_linking_fix --depth 1 --single-branch https://github.com/Pistonite/megaton.git
        working-directory: ${{ runner.temp }}
      - id: build-megaton
        name: Build Megaton
        run: |
          echo "MEGATON_HOME=`pwd`" >> "$GITHUB_ENV"
          cargo run -vr --bin megaton-buildtool -- install || true
          chmod +x bin/megaton
          realpath bin >> "$GITHUB_PATH"
        working-directory: ${{ runner.temp }}/megaton
      - id: megaton
        name: Install Megaton
        run: bash -c '. megaton install -V'
      - id: build
        name: Build project
        run: |
          bash -c '. megaton checkenv'
          bash -c '. megaton build -LVT'
        working-directory: backend
      - id: package
        name: Package artifact
        run: |
          EXEFS=out/atmosphere/contents/01007EF00011E000/exefs
          BUILD="$GITHUB_WORKSPACE"/backend/target/megaton/none
          mkdir -p $EXEFS
          cd $EXEFS
          cp $BUILD/*.nso subsdk9
          cp $BUILD/main.npdm .
        working-directory: ${{ runner.temp }}
      - id: upload
        name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend
          path: ${{ runner.temp }}/out
  build-tauri:
    name: Build Tauri app
    env:
      CI: true
      DO_NOT_TRACK: 1
      CARGO_TERM_COLOR: always
    strategy:
      matrix:
        platform:
          - ubuntu-latest
          - windows-latest
          - macos-26
    runs-on: ${{ matrix.platform }}
    steps:
      - id: checkout
        name: Check out repository
        uses: actions/checkout@v6
      - id: tauri-dependencies
        name: Install Tauri dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file libxdo-dev libssl-dev libayatana-appindicator3-dev librsvg2-dev
      - id: rustup-unix
        name: Install Rust (UNIX only)
        if: matrix.platform == 'ubuntu-latest' || matrix.platform == 'macos-26'
        run: |
          curl -fsSL --tlsv1.3 https://sh.rustup.rs | bash -s -- -vy --no-modify-path
          realpath ~/.cargo/bin >> "$GITHUB_PATH"
      - id: rustup-nightly
        name: Install nightly Rust toolchain (UNIX only)
        if: matrix.platform == 'ubuntu-latest' || matrix.platform == 'macos-26'
        run: |
          rustup update nightly
          rustup default nightly
      - id: rustup-windows
        name: Install Rust (Windows only)
        if: matrix.platform == 'windows-latest'
        run: |
          rustup update nightly-msvc
          rustup default nightly-msvc
      - id: rust-macos
        name: Add macOS Rust targets (macOS only)
        if: matrix.platform == 'macos-26'
        run: rustup target add aarch64-apple-darwin x86_64-apple-darwin
      - id: jetbrains-runtime
        name: Install JetBrains Runtime (Ubuntu only)
        if: matrix.platform == 'ubuntu-latest'
        uses: actions/setup-java@v5
        with:
          distribution: jetbrains
          java-version: 21
      - id: android-environment
        name: Configure Android SDK environment variables (Ubuntu only)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          echo "NDK_HOME=$ANDROID_NDK_HOME" >> "$GITHUB_ENV"
          echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> "$GITHUB_PATH"
      - id: android-licenses
        name: Accept Android SDK licenses (Ubuntu only)
        if: matrix.platform == 'ubuntu-latest'
        run: yes | sdkmanager --licenses > /dev/null
      - id: rust-android
        name: Add Android Rust targets (Ubuntu only)
        if: matrix.platform == 'ubuntu-latest'
        run: rustup target add aarch64-linux-android armv7-linux-androideabi x86_64-linux-android i686-linux-android
      - id: android-signing
        name: Set up Android signing (Ubuntu only)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          echo "password=${{ secrets.ANDROID_KEY_PASSWORD }}" > keystore.properties
          echo keyAlias=upload >> keystore.properties
          base64 -d <<< "${{ secrets.ANDROID_KEY_BASE64 }}" > "$RUNNER_TEMP/keystore.jks"
          echo "storeFile=$RUNNER_TEMP/keystore.jks" >> keystore.properties
        working-directory: frontend/src-tauri/gen/android
      - id: bun
        name: Install Bun
        uses: oven-sh/setup-bun@v2
      - id: dependencies
        name: Install app dependencies
        run: |
          bun i --frozen-lockfile
          bun i -g turbo
        working-directory: frontend
      - id: build-desktop
        name: Build app for desktop
        uses: tauri-apps/tauri-action@v0
        with:
          projectPath: ${{ github.workspace }}/frontend
          tauriScript: turbo --ui stream tauri --
          args: ${{ matrix.platform == 'macos-26' && '-t universal-apple-darwin' || '' }}
      - id: build-android
        name: Build app for Android (Ubuntu only)
        if: matrix.platform == 'ubuntu-latest'
        uses: tauri-apps/tauri-action@v0
        with:
          projectPath: ${{ github.workspace }}/frontend
          tauriScript: turbo --ui stream tauri -- android
      - id: bundle-linux
        name: Bundle Linux artifact
        if: matrix.platform == 'ubuntu-latest'
        run: |
          mkdir binaries-linux
          cd binaries-linux
          for ext in AppImage deb rpm; do
            cp "${{ github.workspace }}"/frontend/src-tauri/target/release/bundle/**/*.$ext "${{ github.event.repository.name }}.$ext"
          done
        working-directory: ${{ runner.temp }}
      - id: bundle-android
        name: Bundle Android artifact
        if: matrix.platform == 'ubuntu-latest'
        run: |
          mkdir binaries-android
          cd binaries-android
          cp "${{ github.workspace }}"/frontend/src-tauri/gen/android/app/build/outputs/apk/universal/release/*.apk "${{ github.event.repository.name }}.apk"
        working-directory: ${{ runner.temp }}
      - id: bundle-windows
        name: Bundle Windows artifact
        if: matrix.platform == 'windows-latest'
        run: |
          New-Item binaries-windows -ItemType Directory
          Set-Location binaries-windows
          Copy-Item "${{ github.workspace }}/frontend/src-tauri/target/release/bundle/**/*.exe" "${{ github.event.repository.name }}.exe"
        working-directory: ${{ runner.temp }}
      - id: bundle-macos
        name: Bundle macOS artifact
        if: matrix.platform == 'macos-26'
        run: |
          mkdir binaries-macos
          cd binaries-macos
          cp "${{ github.workspace }}"/frontend/src-tauri/target/universal-apple-darwin/release/bundle/**/*.dmg "${{ github.event.repository.name }}.dmg"
        working-directory: ${{ runner.temp }}
      - id: upload-linux
        name: Upload Linux artifact
        if: matrix.platform == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-linux
          path: ${{ runner.temp }}/binaries-linux
      - id: upload-android
        name: Upload Android artifact
        if: matrix.platform == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-android
          path: ${{ runner.temp }}/binaries-android
      - id: upload-windows
        name: Upload Windows artifact
        if: matrix.platform == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-windows
          path: ${{ runner.temp }}/binaries-windows
      - id: upload-macos
        name: Upload macOS artifact
        if: matrix.platform == 'macos-26'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-macos
          path: ${{ runner.temp }}/binaries-macos
  build-sveltekit:
    name: Build SvelteKit app
    env:
      CI: true
      DO_NOT_TRACK: 1
      CARGO_TERM_COLOR: always
    runs-on: ubuntu-latest
    steps:
      - id: checkout
        name: Check out repository
        uses: actions/checkout@v6
      - id: bun
        name: Install Bun
        uses: oven-sh/setup-bun@v2
      - id: dependencies
        name: Install app dependencies
        run: |
          bun i --frozen-lockfile
          bun i -g turbo
        working-directory: frontend
      - id: build
        name: Build app for web
        run: turbo --ui stream build
        working-directory: frontend
      - id: upload
        name: Upload web artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-web
          path: ${{ github.workspace }}/frontend/build
  build-proxy:
    name: Build proxy
    env:
      CARGO_TERM_COLOR: always
    strategy:
      matrix:
        platform:
          - ubuntu-latest
          - windows-latest
          - macos-26
    runs-on: ${{ matrix.platform }}
    steps:
      - id: checkout
        name: Check out repository
        uses: actions/checkout@v6
      - id: rustup-unix
        name: Install Rust (UNIX only)
        if: matrix.platform == 'ubuntu-latest' || matrix.platform == 'macos-26'
        run: |
          curl -fsSL --tlsv1.3 https://sh.rustup.rs | bash -s -- -vy --no-modify-path
          realpath ~/.cargo/bin >> "$GITHUB_PATH"
      - id: rustup-nightly
        name: Install nightly Rust toolchain (UNIX only)
        if: matrix.platform == 'ubuntu-latest' || matrix.platform == 'macos-26'
        run: |
          rustup update nightly
          rustup default nightly
      - id: rustup-windows
        name: Install Rust (Windows only)
        if: matrix.platform == 'windows-latest'
        run: |
          rustup update nightly-msvc
          rustup default nightly-msvc
      - id: rust-macos
        name: Add macOS Rust targets (macOS only)
        if: matrix.platform == 'macos-26'
        run: rustup target add aarch64-apple-darwin x86_64-apple-darwin
      - id: build
        name: Build app
        run: cargo build -vr
        working-directory: proxy
      - id: upload-linux
        name: Upload Linux artifact
        if: matrix.platform == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: proxy-linux
          path: proxy/target/release/all-trees-tracker-proxy
      - id: upload-windows
        name: Upload Windows artifact
        if: matrix.platform == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: proxy-windows
          path: proxy/target/release/all-trees-tracker-proxy.exe
      - id: upload-macos
        name: Upload macOS artifact
        if: matrix.platform == 'macos-26'
        uses: actions/upload-artifact@v4
        with:
          name: proxy-macos
          path: proxy/target/release/all-trees-tracker-proxy
  release:
    name: Publish release
    needs: [build-megaton, build-tauri, build-sveltekit, build-proxy]
    if: github.ref_type == 'tag'
    env:
      GH_TOKEN: ${{ github.token }}
    runs-on: ubuntu-latest
    steps:
      - id: checkout
        name: Check out repository
        uses: actions/checkout@v6
      - id: downloaad
        name: Download artifacts
        uses: actions/download-artifact@v5
      - id: bundle
        name: Bundle artifacts
        run: |
          NAME=${{ github.event.repository.name }}
          BACKEND_NAME=$NAME-backend
          FRONTEND_NAME=$NAME-frontend
          PROXY_NAME=$NAME-proxy
          mkdir release
          zip -r release/$BACKEND_NAME backend/*
          for platform in linux android windows macos web; do
            zip -r release/$FRONTEND_NAME-$platform frontend-$platform/*
          done
          for platform in linux windows macos; do
            zip -r release/$PROXY_NAME-$platform proxy-$platform/*
          done
      - id: release-notes
        name: Generate release notes
        uses: mindsers/changelog-reader-action@v2
      - id: release
        name: Create release
        run: gh release create $GITHUB_REF_NAME release/* -n '${{ steps.release-notes.outputs.changes }}'
